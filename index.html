<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total DCF Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --accent-rev: #8e44ad; --bg: #f4f7f6; --text: #333; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Grid Layouts */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; }
        @media (max-width: 900px) { .dashboard-grid, .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

        /* Cards */
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        h2 { margin: 0; font-size: 1.2em; color: var(--primary); }
        h3 { margin: 0; font-size: 1em; color: #666; font-weight: normal; }

        /* Inputs */
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85em; color: var(--primary); }
        input[type="number"], input[type="text"], select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; box-sizing: border-box;
        }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }

        /* Help links */
        .help-link { font-size: 0.75em; color: var(--accent); text-decoration: none; display: block; margin-top: 2px; }
        .help-link:hover { text-decoration: underline; }

        .scenario-box { padding: 10px; border-radius: 6px; border: 1px solid #eee; background: #fafafa; margin-bottom: 10px; }
        .bear { border-left: 4px solid #e74c3c; } .base { border-left: 4px solid #3498db; } .bull { border-left: 4px solid #2ecc71; }
        
        .reverse-box { background: #fdf2ff; border: 1px solid #e8daef; border-radius: 8px; padding: 20px; text-align: center; }
        .implied-rate { font-size: 2.5em; font-weight: bold; color: var(--accent-rev); margin: 10px 0; }
        
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-top: 1px solid #f0f0f0; }
        .result-val { font-weight: bold; font-size: 1.1em; }
        .undervalued { color: #27ae60; } .overvalued { color: #c0392b; }

        button.calc-btn {
            background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px;
        }
        button.calc-btn:hover { background: #34495e; }

        .warning { color: #c0392b; font-weight: 600; }
        .muted { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="card">
        <div class="card-header">
            <h2>1. Felles Input (Hent tall √©n gang)</h2>
            <select id="method" style="width: auto;" onchange="toggleInputs()" aria-label="Velg metode">
                <option value="fcf">Metode: Free Cash Flow</option>
                <option value="eps">Metode: EPS</option>
            </select>
        </div>
        
        <div class="grid-4">
            <div>
                <label for="ticker">Ticker / Selskap</label>
                <input type="text" id="ticker" placeholder="EQNR" oninput="updateLinks()" aria-label="Ticker">
            </div>
            <div>
                <label for="currentPrice">Aksjekurs (NOK)</label>
                <input type="number" id="currentPrice" value="150" step="0.1" aria-label="Aksjekurs">
            </div>
            <div>
                <label for="discountRate">Avkastningskrav (WACC %)</label>
                <input type="number" id="discountRate" value="10.0" step="0.1" aria-label="Avkastningskrav">
            </div>
            <div>
                <label for="shares">Antall Aksjer (Mill)</label>
                <input type="number" id="shares" value="100" aria-label="Antall aksjer">
                <a id="link-shares" href="#" target="_blank" class="help-link">Finn antall aksjer</a>
            </div>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
            <div id="fcf-inputs" class="grid-2">
                <div>
                    <label for="totalFcf">Total Free Cash Flow (Siste 12 mnd, Mill NOK)</label>
                    <input type="number" id="totalFcf" value="1000" aria-label="Total FCF">
                    <a id="link-fcf" href="#" target="_blank" class="help-link">Finn Cash Flow (Yahoo)</a>
                </div>
                <div style="display:flex; align-items:center;">
                    <div style="background:#f8f9fa; padding:10px; border-radius:6px; width:100%;">
                        Startverdi per aksje: <strong id="metricPerShareDisplay" style="font-size:1.2em; color:var(--accent);">10.00</strong> NOK
                    </div>
                </div>
            </div>
            
            <div id="eps-inputs" style="display:none;">
                <label for="epsValue">Earnings Per Share (EPS)</label>
                <input type="number" id="epsValue" value="10.00" aria-label="EPS">
            </div>
        </div>
    </div>

    <div class="dashboard-grid">
        
        <div>
            <div class="card">
                <div class="card-header">
                    <h2>2. Verdsettelse (Forward DCF)</h2>
                    <h3>Hva er aksjen verdt? (5 √•r + Exit)</h3>
                </div>

                <div class="grid-3">
                    <div class="scenario-box bear">
                        <label>üêª Bear (Vekst / Exit)</label>
                        <input type="number" id="bearG" value="2" placeholder="Vekst %" aria-label="Bear vekst">
                        <input type="number" id="bearM" value="10" placeholder="Exit x" style="margin-top:5px;" aria-label="Bear exit">
                        <label style="margin-top:5px;">Sannsynlighet %</label>
                        <input type="number" id="bearP" value="25" aria-label="Bear sannsynlighet">
                    </div>
                    <div class="scenario-box base">
                        <label>üîµ Base (Vekst / Exit)</label>
                        <input type="number" id="baseG" value="8" placeholder="Vekst %" aria-label="Base vekst">
                        <input type="number" id="baseM" value="15" placeholder="Exit x" style="margin-top:5px;" aria-label="Base exit">
                        <label style="margin-top:5px;">Sannsynlighet %</label>
                        <input type="number" id="baseP" value="50" aria-label="Base sannsynlighet">
                    </div>
                    <div class="scenario-box bull">
                        <label>üêÇ Bull (Vekst / Exit)</label>
                        <input type="number" id="bullG" value="15" placeholder="Vekst %" aria-label="Bull vekst">
                        <input type="number" id="bullM" value="20" placeholder="Exit x" style="margin-top:5px;" aria-label="Bull exit">
                        <label style="margin-top:5px;">Sannsynlighet %</label>
                        <input type="number" id="bullP" value="25" aria-label="Bull sannsynlighet">
                    </div>
                </div>
                <small id="probWarning" style="color:red; display:block; text-align:right; min-height:1.2em;"></small>

                <div style="margin-top: 15px; background: #f4f6f7; padding: 15px; border-radius: 8px;">
                    <div class="result-row">
                        <span>Estimert Verdi (Vektet):</span>
                        <span class="result-val" id="valWeighted">--- NOK</span>
                    </div>
                    <div class="result-row" style="border-bottom:none;">
                        <span>Oppside / Nedside:</span>
                        <span class="result-val" id="valUpside">---%</span>
                    </div>
                </div>
                <div style="height: 200px; margin-top:15px;">
                    <canvas id="forwardChart" aria-label="Forward valuations chart"></canvas>
                </div>
            </div>
        </div>

        <div>
            <div class="card">
                <div class="card-header">
                    <h2>3. Forventninger (Reverse DCF)</h2>
                    <h3>Hva priser markedet inn? (10 √•r)</h3>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="termG">Terminal Vekst (etter √•r 10)</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="number" id="termG" value="2.0" step="0.1" style="width:80px;" aria-label="Terminal vekst"> 
                        <span style="font-size:0.9em; color:#666;">% (Evig vekst)</span>
                    </div>
                </div>

                <div class="reverse-box">
                    <div style="text-transform: uppercase; font-size: 0.8em; color: #888; letter-spacing: 1px;">Implisitt Vekstkrav</div>
                    <div class="implied-rate" id="revImplied">---%</div>
                    <div style="font-size: 0.9em; color: #666;" id="revComment">For √• forsvare dagens kurs m√• selskapet vokse med denne raten √•rlig i 10 √•r.</div>
                </div>

                <div style="margin-top: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px;">
                    <div class="result-row" style="border:none; padding:0;">
                        <span>Ditt Base Case (til venstre):</span>
                        <span style="font-weight:bold;" id="dispBaseG">8%</span>
                    </div>
                    <div style="margin-top:10px; font-size:0.9em; line-height:1.4em;" id="revVerdict">
                        ---
                    </div>
                </div>

                <button class="calc-btn" onclick="calculateAll()">OPPDATER ALLE TALL</button>
            </div>
        </div>
    </div>
</div>

<script>
    // State
    let chartFwd = null;
    let debounceTimer = null;
    const fmt = new Intl.NumberFormat('nb-NO', { minimumFractionDigits: 0, maximumFractionDigits: 2 });

    // Utility: safe numeric read
    function getNum(id) { return Number.parseFloat(document.getElementById(id).value) || 0; }

    // Format number for display (NOK)
    function formatN(n, decimals=2) {
        if (!Number.isFinite(n)) return '---';
        return new Intl.NumberFormat('nb-NO', { minimumFractionDigits: 0, maximumFractionDigits: decimals }).format(n);
    }

    // On load: bind listeners and initial calculations
    window.onload = function() {
        updateLinks();
        toggleInputs();
        calculateAll();

        // Debounced updates for inputs
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(el => {
            el.addEventListener('input', () => {
                if (el.id === 'ticker') {
                    updateLinks();
                    return;
                }
                // Debounce heavy calculation
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(calculateAll, 250);
            });
        });
    };

    function updateLinks() {
        const t = (document.getElementById('ticker').value || 'EQNR').toUpperCase();
        document.getElementById('link-fcf').href = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}/cash-flow`;
        document.getElementById('link-shares').href = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}/key-statistics`;
    }

    function toggleInputs() {
        const isFCF = document.getElementById('method').value === 'fcf';
        document.getElementById('fcf-inputs').style.display = isFCF ? 'grid' : 'none';
        document.getElementById('eps-inputs').style.display = isFCF ? 'none' : 'block';
        calculateAll();
    }

    // Main orchestration
    function calculateAll() {
        // --- 1. STARTVERDI ---
        let startVal = 0;
        if (document.getElementById('method').value === 'fcf') {
            const fcf = getNum('totalFcf');
            const shares = getNum('shares');
            if (shares > 0) startVal = (fcf / shares);
            else startVal = NaN;
        } else {
            startVal = getNum('epsValue');
        }
        document.getElementById('metricPerShareDisplay').innerText = Number.isFinite(startVal) ? formatN(startVal, 2) : '---';

        const price = getNum('currentPrice');
        const wacc = getNum('discountRate');

        // Input validations/warnings
        const probSum = getNum('bearP') + getNum('baseP') + getNum('bullP');
        const probWarningEl = document.getElementById('probWarning');
        probWarningEl.innerText = Math.abs(probSum - 100) > 0.1 ? `‚ö†Ô∏è Sum % = ${formatN(probSum,1)}` : '';

        if (!Number.isFinite(startVal) || startVal <= 0) {
            probWarningEl.innerText = '‚ö†Ô∏è Startverdi ugyldig (sjekk FCF / Antall aksjer eller EPS)';
        }

        if (wacc <= 0) {
            probWarningEl.innerText = '‚ö†Ô∏è Avkastningskrav (WACC) b√∏r v√¶re > 0';
        }

        // --- 2. FORWARD DCF (5 √Ör + Exit Multiple) ---
        function calcFwd(gPercent, exitMultiple) {
            // gPercent: yearly growth percent (e.g. 8), exitMultiple e.g. 15
            if (!Number.isFinite(startVal) || startVal <= 0) return NaN;
            let val = 0, curr = startVal;
            let future = [];
            for (let i = 1; i <= 5; i++) {
                curr *= (1 + gPercent / 100);
                val += curr / Math.pow(1 + wacc / 100, i);
                future.push(curr);
            }
            // Terminal by exit multiple
            const term = (future[4] * exitMultiple) / Math.pow(1 + wacc / 100, 5);
            return val + term;
        }

        const bearVal = calcFwd(getNum('bearG'), getNum('bearM'));
        const baseVal = calcFwd(getNum('baseG'), getNum('baseM'));
        const bullVal = calcFwd(getNum('bullG'), getNum('bullM'));

        const wVal = ((bearVal || 0) * getNum('bearP') / 100) + ((baseVal || 0) * getNum('baseP') / 100) + ((bullVal || 0) * getNum('bullP') / 100);

        // Update Forward UI
        document.getElementById('valWeighted').innerText = Number.isFinite(wVal) ? formatN(wVal, 2) + " NOK" : '--- NOK';
        let upDown = price > 0 && Number.isFinite(wVal) ? ((wVal - price) / price) * 100 : 0;
        const upEl = document.getElementById('valUpside');
        upEl.innerText = Number.isFinite(upDown) ? (upDown > 0 ? "+" : "") + upDown.toFixed(1) + "%" : '---';
        upEl.className = "result-val " + (upDown > 0 ? "undervalued" : "overvalued");

        updateChart(bearVal, baseVal, bullVal, wVal, price);

        // --- 3. REVERSE DCF (10 √Ör + Gordon Growth) ---
        const termG = getNum('termG');

        // Solver for Implied Growth (binary search with safeguards)
        const impliedG = solveReverse(price, startVal, wacc, termG);

        const revImpliedEl = document.getElementById('revImplied');
        if (!Number.isFinite(impliedG)) {
            revImpliedEl.innerText = 'Udefinert';
            if (wacc <= termG) {
                document.getElementById('probWarning').innerText = '‚ö†Ô∏è WACC m√• v√¶re st√∏rre enn terminal vekst for √• f√• et gyldig implisitt krav.';
            }
        } else {
            revImpliedEl.innerText = impliedG.toFixed(1) + "%";
        }

        document.getElementById('dispBaseG').innerText = getNum('baseG') + "%";

        // Verdict - construct safe text nodes (avoid innerHTML with unescaped content)
        const verdictDiv = document.getElementById('revVerdict');
        verdictDiv.innerHTML = '';
        const baseG = getNum('baseG');

        if (!Number.isFinite(impliedG)) {
            const span = document.createElement('span');
            span.className = 'warning';
            span.textContent = 'Kan ikke beregne implisitt vekst: sjekk WACC og terminal vekst.';
            verdictDiv.appendChild(span);
        } else if (impliedG > baseG + 2) {
            const span = document.createElement('span');
            span.style.color = '#c0392b';
            span.textContent = `‚ö†Ô∏è H√∏ye forventninger: Markedet krever ${impliedG.toFixed(1)}% √•rlig vekst, mye h√∏yere enn ditt Base Case (${baseG}%).`;
            verdictDiv.appendChild(span);
        } else if (impliedG < baseG - 2) {
            const span = document.createElement('span');
            span.style.color = '#27ae60';
            span.textContent = `‚úÖ Lav terskel: Markedet krever kun ${impliedG.toFixed(1)}% √•rlig vekst. Hvis du tror p√• ${baseG}%, kan dette v√¶re attraktivt.`;
            verdictDiv.appendChild(span);
        } else {
            const span = document.createElement('span');
            span.style.color = '#f39c12';
            span.textContent = `‚öñÔ∏è Fair: Markedets forventning (${impliedG.toFixed(1)}%) er omtrent lik ditt estimat (${baseG}%).`;
            verdictDiv.appendChild(span);
        }
    }

    // Reverse DCF solver: find g such that PV(10-year cashflow + Gordon) ~= targetPrice (per share)
    function solveReverse(targetPrice, startVal, rPercent, terminalGPercent) {
        if (!Number.isFinite(targetPrice) || !Number.isFinite(startVal) || startVal <= 0) return NaN;
        const r = rPercent;
        const gTerm = terminalGPercent;

        // If discount rate is <= terminal growth, Gordon formula would blow up (division by zero or negative). Bail out.
        if (r <= gTerm) return NaN;

        // Calculate PV for a given growth g (percent)
        function calcVal(g) {
            // g is percent
            let val = 0, curr = startVal;
            for (let i = 1; i <= 10; i++) {
                curr *= (1 + g / 100);
                val += curr / Math.pow(1 + r / 100, i);
            }
            // Terminal (Gordon): use gTerm as perpetual growth (percent)
            const termVal = (curr * (1 + gTerm / 100)) / ((r - gTerm) / 100);
            return val + (termVal / Math.pow(1 + r / 100, 10));
        }

        // Start with reasonable bracket, expand if necessary
        let low = -50, high = 100;
        let vLow = calcVal(low), vHigh = calcVal(high);

        // Expand limits if targetPrice outside initial bracket, up to some safety limit
        let expandIter = 0;
        while ((vLow > targetPrice && vHigh > targetPrice) || (vLow < targetPrice && vHigh < targetPrice)) {
            expandIter++;
            if (expandIter > 50) break; // safety
            low -= 50;
            high += 100;
            vLow = calcVal(low);
            vHigh = calcVal(high);
        }

        // Binary search for g
        let mid = 0;
        for (let i = 0; i < 80; i++) {
            mid = (low + high) / 2;
            const v = calcVal(mid);
            if (!Number.isFinite(v)) break;
            const diff = v - targetPrice;
            if (Math.abs(diff) < Math.max(0.1, Math.abs(targetPrice) * 1e-6)) return mid;
            if (v < targetPrice) {
                low = mid;
            } else {
                high = mid;
            }
        }
        return mid;
    }

    // Chart update
    function updateChart(bear, base, bull, weighted, price) {
        const ctx = document.getElementById('forwardChart').getContext('2d');
        if (chartFwd) chartFwd.destroy();
        const data = [
            Number.isFinite(bear) ? bear : 0,
            Number.isFinite(base) ? base : 0,
            Number.isFinite(bull) ? bull : 0,
            Number.isFinite(weighted) ? weighted : 0,
            Number.isFinite(price) ? price : 0
        ];
        chartFwd = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Bear', 'Base', 'Bull', 'Vektet', 'Pris'],
                datasets: [{
                    label: 'NOK',
                    data: data,
                    backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#95a5a6'],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }
</script>

</body>
</html>